name: Deploy to cPanel via FTP

     on:
       push:
         branches:
           - main
       workflow_dispatch: # Permet le déclenchement manuel

     jobs:
       ftp-deploy:
         name: FTP Deploy
         runs-on: ubuntu-latest

         steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
             node-version: '18'
             cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Build Next.js
           run: |
             echo "Starting build..."
             npm run build
             echo "Build completed"

         - name: Verify build output
           run: |
             if [ -d "out" ]; then
               echo "✅ Output directory exists"
               echo "Files in out directory:"
               ls -la out/
               echo "Total files: $(find out -type f | wc -l)"
             else
               echo "❌ Output directory 'out' not found!"
               exit 1
             fi

         - name: Create .htaccess
           run: |
             cat > out/.htaccess << 'EOF'
             RewriteEngine On
             RewriteCond %{REQUEST_FILENAME} !-f
             RewriteCond %{REQUEST_FILENAME} !-d
             RewriteRule ^(.*)$ /index.html [L]

             # Enable compression
             <IfModule mod_deflate.c>
               AddOutputFilterByType DEFLATE text/html text/css
     text/javascript application/javascript
             </IfModule>

             # Cache control
             <IfModule mod_expires.c>
               ExpiresActive On
               ExpiresByType image/jpeg "access plus 1 year"
               ExpiresByType image/png "access plus 1 year"
               ExpiresByType text/css "access plus 1 month"
               ExpiresByType application/javascript "access plus 1 month"
             </IfModule>
             EOF
             echo "✅ .htaccess created"

         - name: Deploy via FTP
           uses: SamKirkland/FTP-Deploy-Action@v4.3.4
           with:
             server: ${{ secrets.FTP_SERVER }}
             username: ${{ secrets.FTP_USERNAME }}
             password: ${{ secrets.FTP_PASSWORD }}
             protocol: ftp
             port: 21
             server-dir: /public_html/beta-valueit.aris-cc.com/
             local-dir: ./out/
             log-level: verbose

